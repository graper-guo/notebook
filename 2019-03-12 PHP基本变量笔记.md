# **2019-03-12 PHP基本变量笔记**
baiyan

源视频地址：http://replay.xesv5.com/ll/2480/af2fbe1abebfe343f08b38161d49d8b4.flv.mp4

## 引入
 - 思考一个问题，$a = 1;这种变量，让你自己设计应该如何去设计？
 - 首先定义一个结构体
 - 类型如何存储？答：用一个char类型的字段存足够，因为char类型最多能够表示256种类型。
 - PHP中以zval表示所有的变量，先看zval的基本结构：
```c
 typedef unsigned char zend_uchar;
 ...
 struct _zval_struct {
	zend_value        value;			/* 存值 */
	union {
		struct {
			ZEND_ENDIAN_LOHI_4(
				zend_uchar    type,  //注意这里就是存放变量类型的地方，char类型
				zend_uchar    type_flags,
				zend_uchar    const_flags,
				zend_uchar    reserved)	   
		} v;
		uint32_t type_info;
	} u1;
	...
};
```
 - 值如何存储？答：如果是a是1用int；如果是1.1，用double；是'1'用char \*......变量的值的类型只有1种，不可能同时用到多种类型，故我们可以把这一大堆东西放到1个union里面即可，源码中存储变量类型的联合体叫做zend_value：
```c
typedef union _zend_value {
	zend_long         lval;	//整型
	double            dval;	//浮点
	zend_refcounted  *counted; //引用计数
	zend_string      *str; //字符串
	zend_array       *arr; //数组
	zend_object      *obj; //对象
	zend_resource    *res; //资源
	zend_reference   *ref; //引用
	zend_ast_ref     *ast; //抽象语法树
	zval             *zv;  //内部使用
	void             *ptr; //不确定类型，取出来之后强转
	zend_class_entry *ce;  //类
	zend_function    *func;//函数
	struct {
		uint32_t w1;
		uint32_t w2;
	} ww; //这个union一共8B，这个结构体每个字段都是4B，因为所有联合体字段共用一块内存，故相当于取了一半的union
} zend_value;
```
 - 我们可以看到，zend_value类型是一个联合体，共占用8B。因为变量只有一种类型，所以就可以利用联合体共用一块内存的特性，来存储变量的类型。注意最后一个结构体是一个小技巧，通过取ww结构体的其中一个字段，可以取到联合体变量高4位或者低4位，这样就不用手动编写多余代码去取了。